Я бы попытался решить через временные таблицы, создаваемые во время запроса
Сделал бы две таблицы и потом заджоинил. К сожалению, оконные функции мне незнакомы, возможно оин могли бы упростить мне задачу :).
